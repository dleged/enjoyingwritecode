
## JavaScriptå®ç°ä¸€ä¸ªä»£ç†æ²™ç®±
> æ²™ç®±è®¾è®¡çš„ç›®çš„ : æ˜¯ä¸ºäº†è®©ä¸å¯ä¿¡çš„ä»£ç è¿è¡Œåœ¨ä¸€å®šçš„ç¯å¢ƒä¸­ï¼Œä»è€Œé™åˆ¶è¿™äº›ä»£ç è®¿é—®éš”ç¦»åŒºä¹‹å¤–çš„èµ„æº

### Sandbox

åœ¨è®¡ç®—æœºå®‰å…¨é¢†åŸŸï¼Œæ²™ç›’ï¼ˆè‹±è¯­ï¼šsandboxï¼Œåˆè¯‘ä¸ºæ²™ç®±ï¼‰æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œä¸ºè¿è¡Œä¸­çš„ç¨‹åºæä¾›çš„éš”ç¦»ç¯å¢ƒã€‚é€šå¸¸æ˜¯ä½œä¸ºä¸€äº›æ¥æºä¸å¯ä¿¡ã€å…·ç ´ååŠ›æˆ–æ— æ³•åˆ¤å®šç¨‹åºæ„å›¾çš„ç¨‹åºæä¾›å®éªŒä¹‹ã€‚

æ²™ç›’é€šå¸¸ä¸¥æ ¼æ§åˆ¶å…¶ä¸­çš„ç¨‹åºæ‰€èƒ½è®¿é—®çš„èµ„æºï¼Œæ¯”å¦‚ï¼Œæ²™ç›’å¯ä»¥æä¾›ç”¨åå³å›æ”¶çš„ç£ç›˜åŠå†…å­˜ç©ºé—´ã€‚åœ¨æ²™ç›’ä¸­ï¼Œç½‘ç»œè®¿é—®ã€å¯¹çœŸå®ç³»ç»Ÿçš„è®¿é—®ã€å¯¹è¾“å…¥è®¾å¤‡çš„è¯»å–é€šå¸¸è¢«ç¦æ­¢æˆ–æ˜¯ä¸¥æ ¼é™åˆ¶ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œæ²™ç›’å±äºè™šæ‹ŸåŒ–çš„ä¸€ç§ã€‚

æ²™ç›’ä¸­çš„æ‰€æœ‰æ”¹åŠ¨å¯¹æ“ä½œç³»ç»Ÿä¸ä¼šé€ æˆä»»ä½•æŸå¤±ã€‚é€šå¸¸ï¼Œè¿™ç§æŠ€æœ¯è¢«è®¡ç®—æœºæŠ€æœ¯äººå‘˜å¹¿æ³›ç”¨äºæµ‹è¯•å¯èƒ½å¸¦æ¯’çš„ç¨‹åºæˆ–æ˜¯å…¶ä»–çš„æ¶æ„ä»£ç ã€‚

### æ²™ç®±å¯ä»¥åšä»€ä¹ˆ

1. è·å–æœåŠ¡å™¨è¿”å›çš„ jsonp æ—¶ï¼Œå¦‚æœä¸ä¿¡ä»» jsonp ä¸­çš„æ•°æ®ï¼Œå¯ä»¥åœ¨æ²™ç®±ä¸­è·å–æ•°æ®ï¼›
2. ä½ æœ‰å¿…è¦æ‰§è¡Œç¬¬ä¸‰æ–¹jsçš„æ—¶å€™ï¼Œè€Œè¿™ä»½jsæ–‡ä»¶åˆä¸ä¸€å®šå¯ä¿¡çš„æ—¶å€™;
3. åœ¨çº¿ä»£ç ç¼–è¾‘å™¨,é˜²æ­¢ä»£ç å¯¹é¡µé¢æœ¬èº«é€ æˆå½±å“;
    - æ ·å¼éš”ç¦»ã€==js æ²™ç®±==ã€é¢„åŠ è½½ç­‰ã€‚

### å‰ç«¯é¢†åŸŸæ²™ç®±çš„ä½¿ç”¨åœºæ™¯
1. [PlayCode - Javascript Playground](https://playcode.io/)
2. [CodeSandbox: Online IDE for Rapid Web Development](https://codesandbox.io/)
3. [**qiankun**](https://qiankun.umijs.org/zh)

### å¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå·±çš„ä»£ç†æ²™ç®±
> ä½¿ç”¨ Es6 çš„ Proxy api


#### å‡è®¾æ²™ç®±æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ï¼š
1. æ¿€æ´»æ²™ç®±å­ï¼Œåªå…è®¸ä½¿ç”¨å½“å‰ script ä½œç”¨åŸŸç¯å¢ƒï¼Œå¹¶ä¸”è¿˜åŸå½“å‰æ²™ç®± window ä¿®æ”¹çš„å€¼ï¼›
2. åˆ‡æ¢å‡ºæ²™ç®±ï¼Œåˆ é™¤å½“å‰æ²™ç®±å¤š window å€¼çš„æ”¹å˜ï¼›

é¦–å…ˆåˆ›å»ºä¸€ä¸ªSnadbox class

```js
   class Sandbox{
       
       constructor(){
           
       }
       
   } 
```

éœ€è¦ä¸€ä¸ªè¢« Proxy ä»£ç†çš„å¯¹è±¡å’Œå¤åˆ¶ä¸€ä¸ª window å¼•ç”¨

```js
    let fakeWindow = Object.create(null);
    let rawWindow = windowï¼›

```

åˆ›å»ºä¿å­˜æ²™ç®±è¿è¡ŒæœŸé—´ï¼Œwindow æ–°å¢ï¼Œä¿®æ”¹å’Œæ›´æ–°çš„3 Map ç±»å‹æ•°ç»„
```js
    // æ²™ç®±æ–°å¢çš„å…¨å±€å˜é‡
    this.addedPropsMapInSandbox = new Map();
    // æ²™ç®±æœŸé—´æ›´æ–°çš„å…¨å±€å˜é‡
    this.modifiedPropsMapInSandbox = new Map();
    // æ²™ç®±æœŸé—´æ–°å¢å’Œä¿®æ”¹çš„å…¨å±€å˜é‡mapï¼Œç”¨äºä»»æ„æ—¶åˆ»çš„ snapshot
    this.currentUpdatesMapInSandbox = new Map();

```

æ¥ä¸‹æ¥æ ¸å¿ƒ Proxy ä»£ç çš„å®ç°

```js

    let target = this;

    this.proxy = new Proxy(fakewindow, {
      set(_, property, value) {

        //window ä¸Šä¸å­˜åœ¨çš„å±æ€§ï¼Œè§†ä¸ºæ–°å¢
        if (!rawWindow[property]) {
          target.addedPropsMapInSandbox.set(property, value);
        }

        //window ä¸Šå­˜åœ¨çš„å±æ€§ï¼Œè§†ä¸ºä¿®æ”¹
        if (rawWindow.hasOwnProperty(property)) {
          target.modifiedPropsMapInSandbox.set(property, value);
        }

        //è®°å½•å½“å‰çŠ¶æ€çš„å¿«ç…§ï¼Œä»¥ä¾¿ä»»ä½•æ˜¯ä¸ªè¿˜åŸæ²™ç®±çŠ¶æ€
        target.currentUpdatesMapInSandbox.set(property, value);

        rawWindow[property] = value;
        return true;
      },
      get(_, property) {
        return window[property];
      }
    });
    
```

ä»¥ä¸Šæ˜¯ constructor ä»£ç ï¼Œæ¥ä¸‹æ¥å†å®ç° active å’Œ inActive æ²™ç®±çš„å®ä¾‹æ–¹æ³•ï¼›

```js

 active(){
 
    //æ¿€æ´»æ²™ç®±æ—¶ï¼Œæ›´æ–°æ²™ç®±å¿«ç…§ï¼Œæ›´æ–° window å¯¹è±¡
    this.currentUpdatesMapInSandbox.forEach((value, key) => {
      window[key] = value;
    });
    
  }

  inActive(){
  
    //ä¸æ¿€æ´»æ²™ç®±æ—¶ï¼Œåˆ é™¤ window ä¸Šæ–°å¢å’Œä¿®æ”¹çš„å¯¹è±¡ï¼›
    this.addedPropsMapInSandbox.forEach((value, key) => {
      delete window[key];
    });
    this.modifiedPropsMapInSandbox.forEach((value, key) => {
      delete window[key];
    });
    
  }

```

### è¯•ä¸€è¯• 

ä½¿ç”¨ä¸‹é¢çš„  çœ‹ä¸‹æ•ˆæœå§ï¼›
```js

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <dark rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <title>Document</title>
    <style>
      pre {
        padding: 30px;
        border: 1px solid black;
        background: white;
        font-size: 16px;
      }
      button{
        height: 30px;
        color: #fff;
        background-color: #343a40;
        border-color: #343a40;
        cursor: pointer;
      }
    </style>
    <script src="./sandbox.js"></script>
    <script>
      let snadbox1 = new Sandbox();
      let p1 = snadbox1.proxy;

      let snadbox2 = new Sandbox();
      let p2 = snadbox2.proxy;

      // eval å‡½æ•°æ‰§è¡Œ JavaScript ä»£ç ï¼Œå¹¶ä¼ å…¥ globalï¼›
      function evalScript(script, global) {
        `${script}}(${global})`;
      }
    </script>
  </head>
  <body>
    <pre id='pre1'>
      // javaScriptæ²™ç®±1
      let a = 0;
      let b = 1;
      window.addition = function(){
        window.result = a = a + 1;
        console.log('addition',a);
      }
    </pre>
    <button class="btn btn-dark" id="snapshot1">init snapshot â‘¡</button>
    <button class="btn btn-dark" id="addition">addition</button>
    <button class="btn btn-dark" id="snadbox1">active snadbox1</button>

    <pre id='pre2'>
      // javaScriptæ²™ç®±2
      let a = 9999;
      let b = 10000;
      window.c = 'ğŸ’…ğŸ’…ğŸ’…ğŸ’…';
      window.minus = function(){
        window.result = a = a - b;
        console.log('minus',a);
      }
    </pre>
    <button class="btn btn-dark" id="snapshot2">init snapshot â‘¡</button>
    <button class="btn btn-dark" id="minus" onClick="minus">minus</button>
    <button class="btn btn-dark" id="snadbox2" onClick="addition">active snadbox2</button>
  </body>

  <script type="text/javascript">

    // é—´æ¥è°ƒç”¨ï¼Œä½¿ç”¨å…¨å±€ä½œç”¨åŸŸ 
    // https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/eval

    let geval = eval;

    /********** åˆå§‹åŒ–ä»£ç ç‰‡æ®µ ******/
    document.getElementById("snapshot1").onclick = function () {
      geval(
        "(function(window){let a = 0;let b = 1;window.addition = function(){ window.result = a = a + b;console.log('addition',a);}}).bind(p1)(p1)"
      );
    };
    document.getElementById("snapshot2").onclick = function () {
      geval(
        "(function(window){let a = 9999;let b = 10000; window.c = 'ğŸ’…ğŸ’…ğŸ’…ğŸ’…';window.minus = function(){ window.result = a = a - b;console.log('minus',a);}}).bind(p2)(p2)"
      );
    };

    /********** æ¿€æ´»æ²™ç®± ******/
    document.getElementById("snadbox1").onclick = function () {
      document.getElementById("pre1").style.background = 'yellow';
      document.getElementById("pre2").style.background = 'white';
      snadbox2.inActive();
      snadbox1.active();
    };

    document.getElementById("snadbox2").onclick = function () {
      document.getElementById("pre1").style.background = 'white';
      document.getElementById("pre2").style.background = 'yellow';
      snadbox1.inActive();
      snadbox2.active();
    };

    /********** è°ƒç”¨æ²™ç®±ä¸­çš„æ–¹æ³• ******/
    document.getElementById("addition").onclick = function () {
      addition();
    };

    document.getElementById("minus").onclick = function () {
      minus();
    };

  </script>
</html>

```

### ç»“æŸ










